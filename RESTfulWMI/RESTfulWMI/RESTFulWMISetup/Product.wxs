<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:iis="http://schemas.microsoft.com/wix/IIsExtension">
  <?define BUILDTARGET="C:\WorkSpace\Microsoft\RestFulWMIComponentBuild\" ?>
  <Product Id="9724e2e5-8746-4c86-978d-29166b6f49b3"
           Name="RESTFulWMISetup"
           Language="1033" Version="1.0.0.0"
           Manufacturer="RESTFulWMISetup"
           UpgradeCode="9724e2e5-8746-4c86-978d-29166b6f49b3">
    <Package InstallerVersion="200" Compressed="yes" Platform="x64" />

    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />
    <Condition Message="You must have administrator privileges to install the application.">
      <![CDATA[Privileged]]>
    </Condition>

    <iis:WebSite Id="DefaultWebSite" Description="Default Web Site">
      <iis:WebAddress Id="AllUnassigned" Port="443"/>
    </iis:WebSite>
    
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder64">
        <Directory Id="INSTALLLOCATION" Name="WindowsServer2012WMIService">
          
          <Component Id="WindowsServer2012WMIComponent" Guid="08D9CCF3-FCB3-43CA-9460-8527138718D2">
            <File Id="service_exe" Name="WindowsServer2012WMIComponentService.exe" Source="$(var.BUILDTARGET)WindowsServer2012WMIComponentService.exe"></File>
            <File Id="user_business_object" Name="UserBusinessObject.dll" Source="$(var.BUILDTARGET)UserBusinessObject.dll"></File>
            <ServiceInstall Id="WindowsServer2012WMIServiceInstaller" Type="ownProcess" Vital="yes" Name="ws2012wmisvc" 
                            DisplayName="Windows Server 2012 Essentials WMI Service" 
                            Description="This service provides the wmi part of the windows server 2012 essentials." 
                            Start="demand" 
                            Account="LocalSystem" ErrorControl="ignore" Interactive="no">
            </ServiceInstall>
            <ServiceControl Id="StartService" Stop="both" Remove="uninstall" Name="ws2012wmisvc"/>
            
          </Component>
          
          <Component Id="Service.IIS.Component" Guid="6FAD9EC7-D2B0-4471-A657-C8AF5F6F707F" KeyPath="yes" Win64="yes">
            
            <iis:WebVirtualDir Id="WindowsServer2012RestService.VirtualDir" Alias="WindowsServer2012RestService" 
                               Directory="INSTALLLOCATION" 
                               WebSite="DefaultWebSite">
              <iis:WebApplication Id="WindowsServer2012RestServiceApp"
                                  Name="WindowsServer2012RestServiceApp" 
                                  WebAppPool="WindowsServer2012RestServicePool"/>
            </iis:WebVirtualDir>
            <iis:WebAppPool Id="WindowsServer2012RestServicePool"
                            Name="WindowsServer2012RestServicePool"
                            ManagedRuntimeVersion="v4.0" ManagedPipelineMode="integrated" Identity="localSystem">
            </iis:WebAppPool>
          </Component>
          
          <Directory Id="GAC" Name="GAC">
            <Component Id="UserBusinessObjectGAC" Guid="22887611-B13E-41EE-897C-D78830E68AEB">
              <File Id="user_business_object_gac" Name="UserBusinessObject.dll" Source="$(var.BUILDTARGET)UserBusinessObject.dll" Assembly=".net" KeyPath="yes"></File>
            </Component>
            <Component Id="WindowsServer2012WMIComponentServiceGAC" Guid="28E9E9B3-3F34-427E-B003-C49B61836E48">
              <File Id="test_exe_gac" Name="WindowsServer2012WMIComponentService.exe" Source="$(var.BUILDTARGET)WindowsServer2012WMIComponentService.exe" Assembly=".net" KeyPath="yes"></File>
            </Component>
          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="ProductFeature" Title="RESTFulWMISetup" Level="1">
      <!-- TODO: Remove the comments around this ComponentRef element and the Component above in order to add resources to this installer. -->
      <!-- <ComponentRef Id="ProductComponent" /> -->

      <!-- Note: The following ComponentGroupRef is required to pull in generated authoring from project references. -->
      <ComponentRef Id="WindowsServer2012WMIComponent" />
      <ComponentRef Id="UserBusinessObjectGAC"/>
      <ComponentRef Id="WindowsServer2012WMIComponentServiceGAC"/>
      <ComponentRef Id="Service.IIS.Component"/>
    </Feature>
  </Product>
</Wix>
